# 路径规划器（Path Planner）模块优化计划

## 1. 优化目标

根据要求，对路径规划器模块进行全面优化，确保：
- TargetSpec标准化，包含明确的定位信息
- 路径搜索健壮性，支持多条路径输出和错误恢复
- ExecutorStep扩展，包含完整的状态信息和可选参数
- 严格职责划分，AI仅用于目标解析
- 完善的异常处理机制
- 规范化的输出结构
- 良好的模块独立性和可测试性

## 2. 优化内容

### 2.1 TargetSpec标准化

**问题**：
- ComponentTarget缺少明确的componentId
- TargetSpec格式需要更直接用于地图节点定位

**优化方案**：
- 扩展ComponentTarget，添加componentId字段
- 确保StateTarget和ComponentTarget包含明确的定位信息
- 为ComponentTarget添加componentRole字段，支持更灵活的组件定位

### 2.2 路径搜索健壮性

**问题**：
- PathSearcher没有记录候选路径来源stateId
- 目标不可达时返回空结果，缺少合理提示

**优化方案**：
- 修改路径搜索算法，记录每条路径的完整状态序列
- 增强错误处理，当目标不可达时返回结构化提示
- 优化visited集合管理，允许在特定条件下重新访问状态

### 2.3 ExecutorStep扩展

**问题**：
- 缺少fromStateId字段
- 状态转换信息不完整

**优化方案**：
- 为ExecutorStep添加fromStateId字段
- 确保每一步明确fromStateId与expectedStateId
- 增强参数支持，允许更复杂的交互操作

### 2.4 异常处理

**问题**：
- 缺少对异常情况的处理策略
- 没有输出结构化的错误信息

**优化方案**：
- 定义规划器异常类，包含结构化错误信息
- 实现对各种异常情况的处理策略：
  - 找不到目标节点
  - 多条路径无优先级可选
  - TargetSpec与UIMap不匹配
- 确保所有异常输出结构化信息，用于后续调试

### 2.5 输出结构规范化

**问题**：
- plannedPath中的每个ExecutorStep缺少fromStateId
- 输出结构需要更规范

**优化方案**：
- 确保PlannerOutput中target、plannedPath、assumptions三部分完整清晰
- 每个ExecutorStep包含intent、fromStateId、expectedStateId、uiBinding
- 增强uiBinding，包含componentId、trigger和可选参数

## 3. 优化后的核心数据结构

### 3.1 TargetSpec优化

```kotlin
sealed class TargetSpec {
    abstract val confidence: Double
    abstract val type: String
}

data class StateTarget(
    val stateId: String,
    override val confidence: Double
) : TargetSpec() {
    override val type: String = "StateTarget"
}

data class ComponentTarget(
    val componentId: String? = null,
    val componentType: String? = null,
    val componentText: String? = null,
    val componentRole: String? = null,
    val componentProperties: Map<String, Any> = emptyMap(),
    override val confidence: Double
) : TargetSpec() {
    override val type: String = "ComponentTarget"
}
```

### 3.2 ExecutorStep优化

```kotlin
data class ExecutorStep(
    val intent: String,
    val fromStateId: String,
    val expectedStateId: String,
    val uiBinding: UIBinding
)

data class UIBinding(
    val componentId: String,
    val trigger: String,
    val parameters: Map<String, Any> = emptyMap()
)
```

### 3.3 规划器异常

```kotlin
sealed class PlannerException(message: String) : Exception(message) {
    abstract val errorCode: String
    abstract val details: Map<String, Any>
}

data class TargetNotFoundException(
    override val errorCode: String = "TARGET_NOT_FOUND",
    override val details: Map<String, Any>
) : PlannerException("找不到匹配的目标节点")

data class PathNotFoundException(
    override val errorCode: String = "PATH_NOT_FOUND",
    override val details: Map<String, Any>
) : PlannerException("找不到从起始状态到目标状态的路径")

data class MultiplePathsException(
    override val errorCode: String = "MULTIPLE_PATHS",
    override val details: Map<String, Any>
) : PlannerException("存在多条路径，无法确定优先级")
```

## 4. 优化后的核心流程

### 4.1 目标解析流程

1. 用户输入自然语言指令
2. TargetResolver（AI）生成标准化的TargetSpec
3. TargetSpec包含明确的stateId或componentId等定位信息

### 4.2 路径规划流程

1. TargetLocator在UIMap中查找匹配TargetSpec的目标节点
2. PathSearcher使用BFS算法搜索所有可能路径，记录完整状态序列
3. PathSelector选择最优路径或备用路径
4. ExecutionFlowGenerator生成执行器步骤序列，包含完整状态信息
5. 输出规范化的PlannerOutput

### 4.3 异常处理流程

1. 检测异常情况
2. 抛出对应的PlannerException，包含结构化错误信息
3. 上层应用捕获异常，根据错误信息进行处理

## 5. 优化后的关键实现

### 5.1 PathSearcher优化

- 修改搜索算法，记录每条路径的完整状态序列
- 增强错误处理，当目标不可达时返回合理提示
- 支持在特定条件下重新访问状态，提高路径搜索的灵活性

### 5.2 ExecutionFlowGenerator优化

- 为每个ExecutorStep添加fromStateId字段
- 确保每一步明确fromStateId与expectedStateId
- 增强参数支持，允许更复杂的交互操作

### 5.3 PathPlanner优化

- 实现完整的异常处理策略
- 确保输出结构化的错误信息
- 优化规划流程，提高模块的健壮性和可扩展性

## 6. 测试策略

- 单元测试：测试各个组件的独立功能
- 集成测试：测试完整的规划流程
- 边界测试：测试异常情况和极限条件
- 模拟测试：模拟各种异常情况，验证异常处理机制

## 7. 优化后的输出示例

```json
{
  "target": {
    "type": "ComponentTarget",
    "componentType": "EditText",
    "componentText": "搜索",
    "componentRole": "search_input",
    "confidence": 0.85
  },
  "plannedPath": [
    {
      "intent": "search",
      "fromStateId": "Main",
      "expectedStateId": "SearchResults",
      "uiBinding": {
        "componentId": "search_bar",
        "trigger": "TEXT",
        "parameters": {
          "text": "测试"
        }
      }
    }
  ],
  "assumptions": {
    "startState": "Main",
    "confidence": 0.9
  }
}
```

## 8. 优化进度

1. ✅ 数据结构优化设计
2. ✅ 核心流程优化设计
3. ⏳ 代码实现
4. ⏳ 测试编写
5. ⏳ 文档完善

通过以上优化，确保路径规划器模块符合所有要求，具有良好的健壮性、可扩展性和可测试性。