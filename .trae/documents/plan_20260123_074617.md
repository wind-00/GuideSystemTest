# 改进AI路径规划器的起始点支持

## 1. 问题分析

当前AI规划器存在的问题：
- AI分析意图时，只考虑目标visibleText，不考虑当前起始点
- 测试用例中虽然传入了起始点，但AI仍可能认为可以直接点击任何按钮
- 缺乏对起始点到目标路径的完整规划

## 2. 改进方案

### 2.1 增强AI意图分析

**目标**：让AI理解当前起始点，规划从起始点到目标的完整路径

**实现思路**：
- 修改AI分析器，在分析意图时考虑当前起始点
- 向GLM API提供更多上下文信息，包括当前页面和可达路径
- 让AI返回目标visibleText，而不是直接返回可点击的按钮

### 2.2 优化EnhancedPlanner

**目标**：确保规划从起始点到目标的完整路径

**实现思路**：
- 保持当前EnhancedPlanner的接口不变
- 确保无论起始点如何，都能正确规划完整路径
- 增强测试用例，覆盖更多起始点场景

### 2.3 增强测试用例

**目标**：验证不同起始点下的路径规划

**实现思路**：
- 添加更多测试用例，覆盖不同起始点
- 测试从第二层级页面跳转到第三层级
- 测试跨层级跳转
- 测试返回路径

## 3. 具体实现步骤

### 3.1 修改AIAnalyzer

1. **增强analyzeIntent方法**：
   - 添加startPage参数
   - 向GLM API提供当前页面信息
   - 提供可达路径上下文

2. **更新GLM API提示词**：
   ```kotlin
   content = "你是一个UI路径规划助手，需要根据用户的自然语言意图和当前起始页面，从提供的可见文本列表中找到最合适的目标。只能从给定的列表中选择，不能生成列表外的内容。返回格式只能是纯文本，直接输出选择的可见文本。"
   ```

3. **提供更多上下文**：
   ```kotlin
   content = "用户意图：$naturalLanguageIntent\n当前起始页面：$startPage\n\n可见文本列表：${visibleTexts.joinToString("\n- ", prefix = "- ")}"
   ```

### 3.2 更新EnhancedPlanner

1. **保持接口不变**：
   ```kotlin
   suspend fun planFromIntent(
       naturalLanguageIntent: String,
       startPage: String = "MainActivity",
       searchStrategy: SearchStrategy = SearchStrategy.BFS
   ): PlanResult
   ```

2. **增强planFromIntent方法**：
   - 将startPage传递给AI分析器
   - 确保规划完整路径

### 3.3 增强测试用例

1. **添加新测试用例**：
   - 从第二层级1跳转到第三层级1
   - 从第三层级返回第二层级
   - 跨层级跳转测试

2. **更新现有测试用例**：
   - 确保测试覆盖不同起始点
   - 验证路径规划的完整性

## 4. 预期效果

- AI能理解当前起始点，规划从起始点到目标的完整路径
- 测试用例覆盖更多起始点场景
- 规划结果更符合实际情况，考虑了起始点限制
- 保持与现有系统的兼容性

## 5. 实现注意事项

- 确保GLM API提示词清晰，明确要求考虑起始点
- 保持向后兼容性，不破坏现有功能
- 增强测试用例，确保覆盖各种场景
- 添加详细的日志，方便调试和验证