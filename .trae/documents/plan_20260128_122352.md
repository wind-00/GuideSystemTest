# 修复应用启动崩溃问题并优化悬浮窗功能

## 问题分析

通过分析崩溃日志，发现应用崩溃的原因是：

```
java.lang.RuntimeException: Unable to start service com.example.orchestrator.overlay.OverlayService@2f4df96 with Intent { cmp=com.example.guidesystemtest/com.example.orchestrator.overlay.OverlayService }: kotlin.UninitializedPropertyAccessException: lateinit property runtimeStateProvider has not been initialized
```

这是因为：
1. 当通过`startService`启动OverlayService时，系统会创建一个新的服务实例
2. 这个新实例的`runtimeStateProvider`属性没有被初始化
3. 当服务启动时调用`updatePageId()`方法时会崩溃

## 修复计划

### 1. 修复OverlayService初始化问题
- 修改OverlayService，添加初始化检查，确保runtimeStateProvider在使用前被初始化
- 在onStartCommand方法中添加初始化逻辑

### 2. 优化悬浮窗功能
- 实现悬浮窗的收起/展开功能
- 确保悬浮窗可以自由移动
- 将按钮文字改为全中文
- 确保悬浮窗与原程序层级不干涉

### 3. 调整MainActivity初始化逻辑
- 移除直接创建OverlayService实例的代码
- 通过Intent传递必要的参数给OverlayService
- 确保服务启动时能正确初始化所有依赖

### 4. 测试验证
- 构建并运行应用，确保不再崩溃
- 测试悬浮窗的收起/展开/移动功能
- 测试完整的AI导航流程

## 技术要点

- 使用Service的生命周期方法正确初始化依赖
- 实现悬浮窗的状态管理（收起/展开）
- 确保悬浮窗的交互不影响原应用
- 使用Intent传递必要的初始化参数

## 预期结果

完成后，用户可以：
1. 正常启动应用，不再崩溃
2. 看到可收起/展开/移动的悬浮窗
3. 在悬浮窗中输入中文目标
4. 观察系统自动规划路径并执行操作
5. 最终到达目标界面

悬浮窗将以中文显示，功能完整，且与原应用不干涉。