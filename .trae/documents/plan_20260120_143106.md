# UI Map Builder AI可规划性修正计划

## 一、问题分析

根据用户要求，我需要修改UI地图生成的Python文件，解决以下问题：

1. 无目标的NAVIGATION效果
2. 返回组件的语义不正确
3. 页面图存在单向死节点
4. ThirdActivity3的btnBack问题（要符合实际app中的代码）
5. navigationRole语义区分不明确
6. STATE\_CHANGE使用无信息占位

## 二、修改计划

### 1. 修改 `effect_parser.py`

* 对于返回操作（finish()或onBackPressed()），设置`navigationRole`为`BACK`

* 为返回操作添加`possibleTargetPageIds`

* 确保所有NAVIGATION效果都有目标

### 2. 修改 `map_validator.py`

* **修复NAVIGATION效果**：确保所有NAVIGATION效果都有`targetPageId`或`possibleTargetPageIds`

* **修复返回组件**：

  * 识别语义为"返回"的组件（componentId包含back或semanticRole=NAVIGATE）

  * 设置`effectType`为`NAVIGATION`，`navigationRole`为`BACK`

  * 显式声明`possibleTargetPageIds`

* **修复单向死节点**：

  * 分析页面跳转关系，建立页面间的导航图

  * 为没有返回路径的页面添加返回效果

* **修复ThirdActivity3**：

  * 确保btnBack是NAVIGATION

  * `possibleTargetPageIds`至少包含`SecondActivity2`

* **区分navigationRole语义**：

  * 前进跳转使用`ENTER_FLOW`

  * 返回使用`BACK`

* **修复STATE\_CHANGE**：

  * 为`stateKey`生成语义明确的名称

  * 为`stateValue`生成具体值，避免统一使用"changed"

### 3. 修改 `effect_extractor.py`

* 为返回组件添加正确的effect

* 确保所有组件的effect都符合要求

## 三、修改步骤

1. 首先修改`map_validator.py`，这是核心的验证和增强逻辑
2. 然后修改`effect_parser.py`，确保初始解析就生成正确的效果
3. 最后修改`effect_extractor.py`，确保效果提取正确
4. 运行脚本生成新的UI地图
5. 验证生成的地图是否符合所有要求

## 四、预期结果

* 所有NAVIGATION效果都有明确的目标

* 所有返回组件都使用正确的语义

* 页面图不存在单向死节点

* ThirdActivity3的btnBack修复完成

* navigationRole语义明确区分

* STATE\_CHANGE使用语义明确的字段值

* 最终UI地图是一个强连通或弱连通可回退的有向图

* 任意页面都能规划出回到ENTRY的路径

