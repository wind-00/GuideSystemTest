# 实现Planner与GLM API结合的意图分析功能

## 1. 实现概述

### 1.1 目标
- 集成GLM4.7flash API，实现人类意图分析
- 自动将自然语言意图映射到UI地图中的visibleText
- 编写完整测试用例，覆盖从意图到路线规划的全流程

### 1.2 主要组件
1. **AIAnalyzer** - AI意图分析模块，调用GLM API
2. **EnhancedPlanner** - 增强版Planner，集成AI分析功能
3. **测试用例** - 完整测试流程的自动化测试

## 2. 核心实现

### 2.1 AI意图分析模块（AIAnalyzer）

**功能**：
- 接收自然语言用户意图
- 调用GLM API分析意图
- 从UI地图的visibleText中匹配最合适的目标
- 返回标准化的UserGoal

**实现**：
- 创建`AIAnalyzer.kt`文件
- 实现HTTP客户端，调用GLM API
- 处理API响应，提取目标visibleText
- 支持错误处理和重试机制

**关键代码**：
```kotlin
class AIAnalyzer(private val apiKey: String, private val uiMap: UiMapModel) {
    suspend fun analyzeIntent(naturalLanguageIntent: String): String {
        // 调用GLM API分析意图
        // 匹配UI地图中的visibleText
        // 返回目标visibleText
    }
}
```

### 2.2 增强版Planner

**功能**：
- 继承现有Planner
- 集成AIAnalyzer
- 支持自然语言意图输入

**实现**：
- 创建`EnhancedPlanner.kt`文件
- 实现`planFromIntent`方法
- 内部调用AIAnalyzer和现有plan方法

**关键代码**：
```kotlin
class EnhancedPlanner(
    uiMap: UiMapModel,
    private val aiAnalyzer: AIAnalyzer
) : Planner(uiMap) {
    suspend fun planFromIntent(
        naturalLanguageIntent: String,
        startPage: String = "MainActivity",
        searchStrategy: SearchStrategy = SearchStrategy.BFS
    ): PlanResult {
        val targetVisibleText = aiAnalyzer.analyzeIntent(naturalLanguageIntent)
        val userGoal = UserGoal(targetVisibleText, startPage, searchStrategy)
        return plan(userGoal)
    }
}
```

### 2.3 API通信实现

**GLM API配置**：
- 模型：GLM4.7flash
- API密钥：17fb3e69b36f471ab107c7605797f8bf.wMPUTygxdEPkBQi3@
- 请求格式：JSON
- 响应格式：JSON，包含分析结果

**HTTP客户端**：
- 使用Ktor HTTP客户端
- 配置超时和重试机制
- 实现请求和响应的序列化/反序列化

### 2.4 测试用例设计

**测试内容**：
1. 基本意图分析测试
2. 复杂意图分析测试
3. 错误意图处理测试
4. 完整流程测试（意图→分析→规划）

**测试特点**：
- 顺序执行，非并发
- 每个测试后停留3秒
- 起点固定为MainActivity
- 覆盖BFS和DFS搜索策略

**测试用例示例**：
```kotlin
@Test
fun `test intent to go to second level`() {
    val intent = "我想跳转到第二层级"
    val result = enhancedPlanner.planFromIntent(intent)
    assertTrue(result.success)
    assertFalse(result.actionPath.isEmpty())
    delay(3000)
}
```

## 3. 依赖管理

### 3.1 新增依赖
- `io.ktor:ktor-client-core` - HTTP客户端核心
- `io.ktor:ktor-client-cio` - CIO引擎
- `io.ktor:ktor-client-content-negotiation` - 内容协商
- `io.ktor:ktor-serialization-kotlinx-json` - JSON序列化
- `org.jetbrains.kotlinx:kotlinx-coroutines-core` - 协程支持

## 4. 实现步骤

### 4.1 第一步：添加依赖
- 更新`build.gradle.kts`，添加所需依赖

### 4.2 第二步：实现AIAnalyzer
- 创建`AIAnalyzer.kt`
- 实现GLM API调用逻辑
- 实现意图映射算法

### 4.3 第三步：实现EnhancedPlanner
- 创建`EnhancedPlanner.kt`
- 集成AIAnalyzer和现有Planner

### 4.4 第四步：编写测试用例
- 创建`AIPlannerTest.kt`
- 实现完整的测试用例
- 添加适当的延迟

### 4.5 第五步：运行测试
- 执行测试用例
- 验证结果
- 调试和修复问题

## 5. 预期结果

- Planner能够接受自然语言意图
- AI模块成功调用GLM API分析意图
- 自动生成正确的路线规划
- 测试用例全部通过
- 系统具有良好的错误处理机制

## 6. 注意事项

- 保护API密钥，避免泄露
- 处理API调用失败的情况
- 确保测试用例顺序执行
- 适当的延迟，避免API限流
- 正确处理GLM API的响应格式